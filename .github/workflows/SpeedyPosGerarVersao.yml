name: SpeedyPos Gerar vers√£o

on:
  workflow_dispatch: # Roda apenas manualmente pelo painel do GitHub
    inputs:
      #version:
      #  description: 'Vers√£o do build'
      #  required: true
      #  default: '1.0.0'
      windows:
        description: "Gerar vers√£o Windows?"
        default: true
        type: boolean
      android:
        description: "Gerar vers√£o Android?"
        default: true
        type: boolean
      android-tef:
        description: "Gerar vers√£o Android(TEF)?"
        default: true
        type: boolean
      android-pagseguro:
        description: "Gerar vers√£o Android(PagSeguro)?"
        default: false
        type: boolean
      android-getnet:
        description: "Gerar vers√£o Android(Getnet)?"
        default: false
        type: boolean
      android-cielo:
        description: "Gerar vers√£o Android(Cielo)?"
        default: false
        type: boolean
      android-rede:
        description: "Gerar vers√£o Android(Rede)?"
        default: false
        type: boolean
      android-stone:
        description: "Gerar vers√£o Android(Stone)?"
        default: false
        type: boolean
      android-ifood:
        description: "Gerar vers√£o Android(IFood)?"
        default: false
        type: boolean
      ios:
        description: "Gerar vers√£o iOS?"
        default: false
        type: boolean
      email:
        description: "Deseja enviar email ao finalizar?"
        default: true
        type: boolean

env:
  VERSION: ${{vars.VERSAO}}
  BUILD: ${{vars.build}}
  SENHA_CERTIFICADO_CLOUDFY: ${{ secrets.SENHA_CERTIFICADO_CLOUDFY }}
  SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_KEY }}
  SIGNATURE_APP_ID: ${{ secrets.SIGNATURE_APP_ID }}
  SIGNATURE_CERTIFICATE_NAME: ${{ secrets.SIGNATURE_CERTIFICATE_NAME }}
  SIGNATURE_VAULT_ID: ${{ secrets.SIGNATURE_VAULT_ID }}
  SIGNATURE_PASSWORD: ${{ secrets.SIGNATURE_PASSWORD }}
  SIGNATURE_TENANT_ID: ${{ secrets.SIGNATURE_TENANT_ID }}

jobs:
  Windows:
    runs-on: windows-latest

    defaults:
      run:
        working-directory: ./flutter/speed
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        if: ${{ inputs.windows }}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main # ou a branch/tag desejada
          token: ${{ secrets.GH_TOKEN }}
          path: flutter
      - name: Instalar NSIS
        if: ${{ inputs.windows }}
        run: |
          choco install nsis -y
          echo "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verificar instala√ß√£o
        if: ${{ inputs.windows }}
        run: makensis /VERSION
      - name: Instalar AzureSignTool
        if: ${{ inputs.windows }}
        run: dotnet tool install --global AzureSignTool

      # - name: assinar dll
      #   run: azuresigntool sign -kvu "${{env.SIGNATURE_VAULT_ID}}" -kvc "${{env.SIGNATURE_CERTIFICATE_NAME}}" -kvi "${{env.SIGNATURE_APP_ID}}" -kvs "${{env.SIGNATURE_PASSWORD}}" --azure-key-vault-tenant-id "${{env.#SIGNATURE_TENANT_ID}}" -tr http://timestamp.digicert.com -td sha256 ./dlls/CliSiTef64I.dll
      # checkout do repositorio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ inputs.windows }}
        with:
          path: version-repo
        # Lendo a vers√£o atual do reposit√≥rio
      - name: Ler vers√£o atual
        if: ${{ inputs.windows }}
        working-directory: version-repo
        shell: powershell
        run: |
          $json = Get-Content "versionWindows.json" | ConvertFrom-Json          
          $json.speedy.version++
          $json.speedy.patch = 0

          # Salva de volta no JSON
          $json | ConvertTo-Json -Depth 10 | Out-File -FilePath "versionWindows.json" -Encoding UTF8

          echo "Versao gerada: $($json.speedy.simple).$($json.speedy.version).$($json.speedy.patch)"
          echo "VERSAO=$($json.speedy.simple).$($json.speedy.version).$($json.speedy.patch)" >> $env:GITHUB_ENV

      - name: Gerando o env/prod.json
        if: ${{ inputs.windows }}
        run: |
          New-Item -ItemType Directory -Path "./env" -Force | Out-Null
          Set-Content -Path "./env/prod.json" -Value '${{ secrets.ENV_PROD }}'
        shell: pwsh
      - name: Atualiza vers√£o no arquivo Dart
        if: ${{ inputs.windows }}
        shell: pwsh
        run: |
          $filePath = "lib/Environment/Version.dart"
          $novaVersao = "${{ env.VERSAO }}"  # ou outro valor din√¢mico
          (Get-Content $filePath) -replace 'const String Version = ".*?"', "const String Version = `"$novaVersao`"" | Set-Content $filePath

      - name: Criar pasta dist
        if: ${{ inputs.windows }}
        run: |
          mkdir dist
        shell: pwsh

      - name: Atualizar vers√£o
        if: ${{ inputs.windows }}
        shell: pwsh
        run: |
          (Get-Content pubspec.yaml) -replace '^version:.*', "version: $env:VERSAO" | Set-Content pubspec.yaml
      - name: Ajeitar o longpath do git
        if: ${{ inputs.windows }}
        run: |
          git config --system core.longpaths true
      - name: üê¶ Setup Shorebird
        if: ${{ inputs.windows }}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true
      # Set Up Java (O Sentry precisa do java para compilar)
      - name: Set Up Java
        if: ${{ inputs.windows }}
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: "17"

      #- name: Mostrar caminho e conte√∫do do prod.json
      #  run: |
      #      $filePath = Resolve-Path "./env/prod.json"
      #      Write-Host "üìÅ Caminho do arquivo: $filePath"
      #      Write-Host "üìÑ Conte√∫do do arquivo:"
      #      Get-Content $filePath | ForEach-Object { Write-Host $_ }
      #  shell: pwsh
      #

      - name: Build Windows EXE
        shell: pwsh
        if: ${{ inputs.windows }}
        run: shorebird release windows --flutter-version ${{vars.FLUTTER_VERSION_SDK_WINDOWS}} --no-confirm '--' --dart-define-from-file=env/prod.json
        continue-on-error: true
      - name: Verificar execut√°vel gerado com sucesso
        if: ${{ inputs.windows }}
        shell: pwsh
        run: |
          if (!(Test-Path "build/windows/x64/runner/Release/speed.exe")) {
          Write-Error "Arquivo 'speed.exe' n√£o encontrado. Abortando workflow."
          exit 1
          } else {
          Write-Host "‚úÖ Build gerado com sucesso."
          }

      #- name: Assinar o execut√°vel
      #  run: sign.bat
      - name: Gerar o instalador
        if: ${{ inputs.windows }}
        run: |
          .\sign.bat  
          makensis windowsinstallmaker.nsi
          .\signinstall.bat
      #- name: Assinar o instalador
      #  run: signinstall.bat

      - name: Criando o release
        if: ${{ inputs.windows }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_SpeedyWindows
          name: v${{ env.VERSAO }}_SpeedyWindows
          files: |
            flutter/speed/dist/CloudfySpeedyPos.exe
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados windows
        if: ${{ inputs.windows }}
        shell: pwsh
        id: api_call_windows
        run: |
          # Monta a URL do APK
          $URL = "https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_SpeedyWindows/CloudfySpeedyPos.exe"

          Write-Host "URL gerada:"
          Write-Host $URL

          Write-Host "Chamando API de valida√ß√£o..."

          # Monta o JSON usando Here-String
          $JSON_DATA = @"
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URL",
              "NR_ID": 4
            }
          }
          "@

          Write-Host "JSON enviado:"
          Write-Host $JSON_DATA

          # Executa o CURL
          $response = curl -s -o response.txt -w "%{http_code}" `
            -X POST https://api.cloudfy.net.br/H02SF0107A `
            -H "Content-Type: application/json" `
            -d $JSON_DATA

          Write-Host "C√≥digo HTTP: $response"

          # Mostra o retorno
          Get-Content response.txt

          if ($response -ne "200") {
            Write-Host "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          }
      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ inputs.windows }}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ inputs.windows }}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build windows"
          cwd: ./version-repo
          add: "versionWindows.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  android-cielo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutter/speed

    steps:
      - name: Gerar Vari√°veis de Ambiente
        working-directory: .
        id: compute
        run: |
          echo 'DeployName=cielo' >> $GITHUB_ENV
          echo 'DeployNameUpperCase=Cielo' >> $GITHUB_ENV
          echo 'UrlId=14' >> $GITHUB_ENV
          VARIABLE=${{ github.event.inputs.android-cielo }}

          # Converte string para 0/1
          if [ "$VARIABLE" = "true" ]; then VARIABLE_BOOL=1; else VARIABLE_BOOL=0; fi          


          # OR l√≥gico
          if [ $((VARIABLE_BOOL)) -eq 1 ]; then
            EXECUTE=true
          else
            EXECUTE=false
          fi

          echo "Valor do execute: $EXECUTE"

          echo "execute=$EXECUTE" >> $GITHUB_OUTPUT
      # Clonar o reposit√≥rio principal do Flutter
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutter

      # Clonar o reposit√≥rio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          path: version-repo

      # Ler e atualizar a vers√£o
      - name: Ler vers√£o atual
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        shell: bash
        run: |
          VERSION_FILE="version${{env.DeployNameUpperCase}}.json"

          # Atualiza o JSON corretamente
          jq '.speedy.build += 1 | .speedy.version += 1 | .speedy.patch = 0' "$VERSION_FILE" > tmp.json

          mv tmp.json "$VERSION_FILE"

          # Pega os valores ap√≥s a atualiza√ß√£o
          BUILD=$(jq -r '.speedy.build' "$VERSION_FILE")
          VERSION=$(jq -r '.speedy.version' "$VERSION_FILE")
          SIMPLE=$(jq -r '.speedy.simple' "$VERSION_FILE")

          echo "Versao Build: $BUILD"
          echo "Versao Version: $VERSION"
          echo "Versao Gerada: $SIMPLE.$VERSION.0"

          echo "VERSAO=$SIMPLE.$VERSION.0" >> $GITHUB_ENV
          echo "VERSAO_BUILD=$BUILD" >> $GITHUB_ENV

          echo "Novo JSON:"
          cat "$VERSION_FILE"

      # Criar o arquivo env/prod.json
      - name: Gerar env/prod.json
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          mkdir -p ./env
          echo '${{ secrets.ENV_PROD }}' > ./env/prod.json
          cat ./env/prod.json

      # Criar arquivo .jks a partir de base64
      - name: Criar arquivo .jks
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          mkdir -p certificado
          echo "${{ secrets.KEYSTORE }}" | base64 -d > certificado/certificado-keystore.jks

      # Setup Shorebird
      - name: üê¶ Setup Shorebird
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # Criar arquivo key.properties
      - name: Criar arquivo key.properties
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          echo "storePassword=${{ secrets.SENHA_KEYSTORE }}" > android/key.properties
          echo "keyPassword=${{ secrets.SENHA_KEYSTORE }}" >> android/key.properties
          echo "keyAlias=cloudfycardapio" >> android/key.properties
          echo "storeFile=../../certificado/certificado-keystore.jks" >> android/key.properties

      # Set Up Java (usando Oracle JDK 17)
      - name: Set Up Java
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: "17"

      # Atualizar vers√£o no arquivo Dart
      - name: Atualiza vers√£o no arquivo Dart e pubspec.yaml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          FILE="lib/Environment/Version.dart"
          NOVA_VERSAO="${{ env.VERSAO }}"
          sed -i "s/const String Version = \".*\"/const String Version = \"$NOVA_VERSAO\"/" $FILE
          cat lib/Environment/Version.dart
          sed -i "s/^version:.*/version: $VERSAO+${{ env.VERSAO_BUILD }}/" pubspec.yaml
          cat pubspec.yaml

      # Executar build do Shorebird
      - name: üöÄ Shorebird Release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        id: shorebird-release
        uses: shorebirdtech/shorebird-release@v1
        with:
          args: --flavor=${{env.DeployName}} --artifact apk -- --dart-define-from-file=env/prod.json --dart-define=FLAVOR=${{env.DeployName}}
          platform: android
          flutter-version: ${{vars.FLUTTER_VERSION_SDK_ANDROID_SMART}}
          working-directory: ./flutter/speed

      - name: Renomear arquivos Android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: .
        run: |
          echo "Renomeando APK"
          if [ -f "flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk" ]; then
            mv flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
            echo "APK renomeado para CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          else
            echo "‚ö†Ô∏è APK n√£o encontrado!"
          fi

      - name: Criando o release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          files: |
            flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          URLANDROID="https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          echo "$URLANDROID"
          echo "Chamando API de valida√ß√£o..."

          JSON_DATA=$(cat <<EOF
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URLANDROID",
              "NR_ID": ${{ env.UrlId }}
            }
          }
          EOF
          )

          echo $JSON_DATA

          response=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST https://api.cloudfy.net.br/H02SF0107A \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA")

          echo "C√≥digo HTTP: $response"
          cat response.txt

          if [ "$response" != "200" ]; then
            echo "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          fi

      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build ${{env.DeployNameUpperCase}}"
          cwd: ./version-repo
          add: "version${{env.DeployNameUpperCase}}.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
  android-stone:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutter/speed

    steps:
      - name: Gerar Vari√°veis de Ambiente
        working-directory: .
        id: compute
        run: |
          echo 'DeployName=stone' >> $GITHUB_ENV
          echo 'DeployNameUpperCase=Stone' >> $GITHUB_ENV
          echo 'UrlId=17' >> $GITHUB_ENV
          VARIABLE=${{ github.event.inputs.android-stone }}

          # Converte string para 0/1
          if [ "$VARIABLE" = "true" ]; then VARIABLE_BOOL=1; else VARIABLE_BOOL=0; fi          


          # OR l√≥gico
          if [ $((VARIABLE_BOOL)) -eq 1 ]; then
            EXECUTE=true
          else
            EXECUTE=false
          fi

          echo "Valor do execute: $EXECUTE"

          echo "execute=$EXECUTE" >> $GITHUB_OUTPUT
      # Clonar o reposit√≥rio principal do Flutter
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutter

      # Clonar o reposit√≥rio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          path: version-repo

      # Ler e atualizar a vers√£o
      - name: Ler vers√£o atual
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        shell: bash
        run: |
          VERSION_FILE="version${{env.DeployNameUpperCase}}.json"

          # Atualiza o JSON corretamente
          jq '.speedy.build += 1 | .speedy.version += 1 | .speedy.patch = 0' "$VERSION_FILE" > tmp.json

          mv tmp.json "$VERSION_FILE"

          # Pega os valores ap√≥s a atualiza√ß√£o
          BUILD=$(jq -r '.speedy.build' "$VERSION_FILE")
          VERSION=$(jq -r '.speedy.version' "$VERSION_FILE")
          SIMPLE=$(jq -r '.speedy.simple' "$VERSION_FILE")

          echo "Versao Build: $BUILD"
          echo "Versao Version: $VERSION"
          echo "Versao Gerada: $SIMPLE.$VERSION.0"

          echo "VERSAO=$SIMPLE.$VERSION.0" >> $GITHUB_ENV
          echo "VERSAO_BUILD=$BUILD" >> $GITHUB_ENV

          echo "Novo JSON:"
          cat "$VERSION_FILE"

      # Criar o arquivo env/prod.json
      - name: Gerar env/prod.json
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          mkdir -p ./env
          echo '${{ secrets.ENV_PROD }}' > ./env/prod.json
          cat ./env/prod.json

      # Criar arquivo .jks a partir de base64
      - name: Criar arquivo .jks
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          mkdir -p certificado
          echo "${{ secrets.KEYSTORE }}" | base64 -d > certificado/certificado-keystore.jks

      # Setup Shorebird
      - name: üê¶ Setup Shorebird
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # Criar arquivo key.properties
      - name: Criar arquivo key.properties
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          echo "storePassword=${{ secrets.SENHA_KEYSTORE }}" > android/key.properties
          echo "keyPassword=${{ secrets.SENHA_KEYSTORE }}" >> android/key.properties
          echo "keyAlias=cloudfycardapio" >> android/key.properties
          echo "storeFile=../../certificado/certificado-keystore.jks" >> android/key.properties

      # Set Up Java (usando Oracle JDK 17)
      - name: Set Up Java
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: "17"

      # Atualizar vers√£o no arquivo Dart
      - name: Atualiza vers√£o no arquivo Dart e pubspec.yaml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          FILE="lib/Environment/Version.dart"
          NOVA_VERSAO="${{ env.VERSAO }}"
          sed -i "s/const String Version = \".*\"/const String Version = \"$NOVA_VERSAO\"/" $FILE
          cat lib/Environment/Version.dart
          sed -i "s/^version:.*/version: $VERSAO+${{ env.VERSAO_BUILD }}/" pubspec.yaml
          cat pubspec.yaml

      # Executar build do Shorebird
      - name: üöÄ Shorebird Release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        id: shorebird-release
        uses: shorebirdtech/shorebird-release@v1
        with:
          args: --flavor=${{env.DeployName}} --artifact apk -- --dart-define-from-file=env/prod.json --dart-define=FLAVOR=${{env.DeployName}}
          platform: android
          flutter-version: ${{vars.FLUTTER_VERSION_SDK_ANDROID_SMART}}
          working-directory: ./flutter/speed

      - name: Renomear arquivos Android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: .
        run: |
          echo "Renomeando APK"
          if [ -f "flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk" ]; then
            mv flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
            echo "APK renomeado para CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          else
            echo "‚ö†Ô∏è APK n√£o encontrado!"
          fi

      - name: Criando o release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          files: |
            flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          URLANDROID="https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          echo "$URLANDROID"
          echo "Chamando API de valida√ß√£o..."

          JSON_DATA=$(cat <<EOF
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URLANDROID",
              "NR_ID": ${{ env.UrlId }}
            }
          }
          EOF
          )

          echo $JSON_DATA

          response=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST https://api.cloudfy.net.br/H02SF0107A \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA")

          echo "C√≥digo HTTP: $response"
          cat response.txt

          if [ "$response" != "200" ]; then
            echo "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          fi

      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build ${{env.DeployNameUpperCase}}"
          cwd: ./version-repo
          add: "version${{env.DeployNameUpperCase}}.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  android-pagseguro:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutter/speed

    steps:
      - name: Gerar Vari√°veis de Ambiente
        working-directory: .
        id: compute
        run: |
          echo 'DeployName=pagseguro' >> $GITHUB_ENV
          echo 'DeployNameUpperCase=Pagseguro' >> $GITHUB_ENV
          echo 'UrlId=12' >> $GITHUB_ENV
          VARIABLE=${{ github.event.inputs.android-pagseguro }}

          # Converte string para 0/1
          if [ "$VARIABLE" = "true" ]; then VARIABLE_BOOL=1; else VARIABLE_BOOL=0; fi          


          # OR l√≥gico
          if [ $((VARIABLE_BOOL)) -eq 1 ]; then
            EXECUTE=true
          else
            EXECUTE=false
          fi

          echo "Valor do execute: $EXECUTE"

          echo "execute=$EXECUTE" >> $GITHUB_OUTPUT
      # Clonar o reposit√≥rio principal do Flutter
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutter

      # Clonar o reposit√≥rio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          path: version-repo

      # Ler e atualizar a vers√£o
      - name: Ler vers√£o atual
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        shell: bash
        run: |
          VERSION_FILE="version${{env.DeployNameUpperCase}}.json"

          # Atualiza o JSON corretamente
          jq '.speedy.build += 1 | .speedy.version += 1 | .speedy.patch = 0' "$VERSION_FILE" > tmp.json

          mv tmp.json "$VERSION_FILE"

          # Pega os valores ap√≥s a atualiza√ß√£o
          BUILD=$(jq -r '.speedy.build' "$VERSION_FILE")
          VERSION=$(jq -r '.speedy.version' "$VERSION_FILE")
          SIMPLE=$(jq -r '.speedy.simple' "$VERSION_FILE")

          echo "Versao Build: $BUILD"
          echo "Versao Version: $VERSION"
          echo "Versao Gerada: $SIMPLE.$VERSION.0"

          echo "VERSAO=$SIMPLE.$VERSION.0" >> $GITHUB_ENV
          echo "VERSAO_BUILD=$BUILD" >> $GITHUB_ENV

          echo "Novo JSON:"
          cat "$VERSION_FILE"

      # Criar o arquivo env/prod.json
      - name: Gerar env/prod.json
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          mkdir -p ./env
          echo '${{ secrets.ENV_PROD }}' > ./env/prod.json
          cat ./env/prod.json

      # Criar arquivo .jks a partir de base64
      - name: Criar arquivo .jks
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          mkdir -p certificado
          echo "${{ secrets.KEYSTORE }}" | base64 -d > certificado/certificado-keystore.jks

      # Setup Shorebird
      - name: üê¶ Setup Shorebird
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # Criar arquivo key.properties
      - name: Criar arquivo key.properties
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          echo "storePassword=${{ secrets.SENHA_KEYSTORE }}" > android/key.properties
          echo "keyPassword=${{ secrets.SENHA_KEYSTORE }}" >> android/key.properties
          echo "keyAlias=cloudfycardapio" >> android/key.properties
          echo "storeFile=../../certificado/certificado-keystore.jks" >> android/key.properties

      # Set Up Java (usando Oracle JDK 17)
      - name: Set Up Java
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: "17"

      # Atualizar vers√£o no arquivo Dart
      - name: Atualiza vers√£o no arquivo Dart e pubspec.yaml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          FILE="lib/Environment/Version.dart"
          NOVA_VERSAO="${{ env.VERSAO }}"
          sed -i "s/const String Version = \".*\"/const String Version = \"$NOVA_VERSAO\"/" $FILE
          cat lib/Environment/Version.dart
          sed -i "s/^version:.*/version: $VERSAO+${{ env.VERSAO_BUILD }}/" pubspec.yaml
          cat pubspec.yaml

      # Executar build do Shorebird
      - name: üöÄ Shorebird Release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        id: shorebird-release
        uses: shorebirdtech/shorebird-release@v1
        with:
          args: --flavor=${{env.DeployName}} --artifact apk -- --dart-define-from-file=env/prod.json --dart-define=FLAVOR=${{env.DeployName}}
          platform: android
          flutter-version: ${{vars.FLUTTER_VERSION_SDK_ANDROID_SMART}}
          working-directory: ./flutter/speed

      - name: Renomear arquivos Android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: .
        run: |
          echo "Renomeando APK"
          if [ -f "flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk" ]; then
            mv flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
            echo "APK renomeado para CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          else
            echo "‚ö†Ô∏è APK n√£o encontrado!"
          fi

      - name: Criando o release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          files: |
            flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          URLANDROID="https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          echo "$URLANDROID"
          echo "Chamando API de valida√ß√£o..."

          JSON_DATA=$(cat <<EOF
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URLANDROID",
              "NR_ID": ${{ env.UrlId }}
            }
          }
          EOF
          )

          echo $JSON_DATA

          response=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST https://api.cloudfy.net.br/H02SF0107A \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA")

          echo "C√≥digo HTTP: $response"
          cat response.txt

          if [ "$response" != "200" ]; then
            echo "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          fi

      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build ${{env.DeployNameUpperCase}}"
          cwd: ./version-repo
          add: "version${{env.DeployNameUpperCase}}.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
  android-getnet:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutter/speed

    steps:
      - name: Gerar Vari√°veis de Ambiente
        working-directory: .
        id: compute
        run: |
          echo 'DeployName=getnet' >> $GITHUB_ENV
          echo 'DeployNameUpperCase=Getnet' >> $GITHUB_ENV
          echo 'UrlId=13' >> $GITHUB_ENV
          VARIABLE=${{ github.event.inputs.android-getnet }}

          # Converte string para 0/1
          if [ "$VARIABLE" = "true" ]; then VARIABLE_BOOL=1; else VARIABLE_BOOL=0; fi          


          # OR l√≥gico
          if [ $((VARIABLE_BOOL)) -eq 1 ]; then
            EXECUTE=true
          else
            EXECUTE=false
          fi

          echo "Valor do execute: $EXECUTE"

          echo "execute=$EXECUTE" >> $GITHUB_OUTPUT
      # Clonar o reposit√≥rio principal do Flutter
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutter

      # Clonar o reposit√≥rio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          path: version-repo

      # Ler e atualizar a vers√£o
      - name: Ler vers√£o atual
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        shell: bash
        run: |
          VERSION_FILE="version${{env.DeployNameUpperCase}}.json"

          # Atualiza o JSON corretamente
          jq '.speedy.build += 1 | .speedy.version += 1 | .speedy.patch = 0' "$VERSION_FILE" > tmp.json

          mv tmp.json "$VERSION_FILE"

          # Pega os valores ap√≥s a atualiza√ß√£o
          BUILD=$(jq -r '.speedy.build' "$VERSION_FILE")
          VERSION=$(jq -r '.speedy.version' "$VERSION_FILE")
          SIMPLE=$(jq -r '.speedy.simple' "$VERSION_FILE")

          echo "Versao Build: $BUILD"
          echo "Versao Version: $VERSION"
          echo "Versao Gerada: $SIMPLE.$VERSION.0"

          echo "VERSAO=$SIMPLE.$VERSION.0" >> $GITHUB_ENV
          echo "VERSAO_BUILD=$BUILD" >> $GITHUB_ENV

          echo "Novo JSON:"
          cat "$VERSION_FILE"
        # Xunxo getnet - Remover lib Url_Launcher
      - name: Xunxo getnet
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          sed -i '/url_launcher:/d' ../corp/pubspec.yaml
          sed -i "/url_launcher/d" ../corp/lib/Services/CfyFileSystem.dart
          sed -i '/static Future OpenFileDefaultSO/,/}/c\static Future OpenFileDefaultSO(String ValuePath) async {' ../corp/lib/Services/CfyFileSystem.dart

      # Criar o arquivo env/prod.json
      - name: Gerar env/prod.json
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          mkdir -p ./env
          echo '${{ secrets.ENV_PROD }}' > ./env/prod.json
          cat ./env/prod.json

      # Criar arquivo .jks a partir de base64
      - name: Criar arquivo .jks
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          mkdir -p certificado
          echo "${{ secrets.KEYSTORE }}" | base64 -d > certificado/certificado-keystore.jks

      # Setup Shorebird
      - name: üê¶ Setup Shorebird
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # Criar arquivo key.properties
      - name: Criar arquivo key.properties
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          echo "storePassword=${{ secrets.SENHA_KEYSTORE }}" > android/key.properties
          echo "keyPassword=${{ secrets.SENHA_KEYSTORE }}" >> android/key.properties
          echo "keyAlias=cloudfycardapio" >> android/key.properties
          echo "storeFile=../../certificado/certificado-keystore.jks" >> android/key.properties

      # Set Up Java (usando Oracle JDK 17)
      - name: Set Up Java
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: "17"

      - name: üõ†Ô∏è Instalar apktool correto + aapt2
        working-directory: version-repo
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          sudo apt remove -y apktool
          wget https://raw.githubusercontent.com/iBotPeaches/Apktool/main/scripts/linux/apktool          

          chmod +x apktool
          sudo mv apktool /usr/local/bin/
          sudo cp apktool_2.9.3.jar /usr/local/bin/apktool.jar

          sudo apt update
          sudo apt install -y zipalign apksigner
          apktool --version
          apktool --use-aapt2

      # Atualizar vers√£o no arquivo Dart
      - name: Atualiza vers√£o no arquivo Dart e pubspec.yaml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          FILE="lib/Environment/Version.dart"
          NOVA_VERSAO="${{ env.VERSAO }}"
          sed -i "s/const String Version = \".*\"/const String Version = \"$NOVA_VERSAO\"/" $FILE
          cat lib/Environment/Version.dart
          sed -i "s/^version:.*/version: $VERSAO+${{ env.VERSAO_BUILD }}/" pubspec.yaml
          cat pubspec.yaml

      # Executar build do Shorebird
      - name: üöÄ Shorebird Release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        id: shorebird-release
        uses: shorebirdtech/shorebird-release@v1
        with:
          args: --flavor=${{env.DeployName}} --artifact apk -- --dart-define-from-file=env/prod.json --dart-define=FLAVOR=${{env.DeployName}}
          platform: android
          flutter-version: ${{vars.FLUTTER_VERSION_SDK_ANDROID_SMART}}
          working-directory: ./flutter/speed

      - name: üì¶ Extrair APK com apktool
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          apktool d build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk -o app-decoded -f
      - name: ‚úèÔ∏è Alterar minSdkVersion no apktool.yml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          sed -i 's/minSdkVersion:.*/minSdkVersion: 22/' app-decoded/apktool.yml
          cat app-decoded/apktool.yml

      - name: ‚úèÔ∏è Alterar extractNativeLibs no AndroidManifest.xml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          MANIFEST="app-decoded/AndroidManifest.xml"

          if grep -q "extractNativeLibs" "$MANIFEST"; then
            sed -i 's/android:extractNativeLibs="false"/android:extractNativeLibs="true"/' "$MANIFEST"
          else
            sed -i 's/<application /<application android:extractNativeLibs="true" /' "$MANIFEST"
          fi
      - name: üî® Rebuild APK
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          apktool b app-decoded -o app-unsigned.apk

      - name: üìè Zipalign APK
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          zipalign -f 4 app-unsigned.apk app-aligned.apk

      - name: ‚úçÔ∏è Assinar APK (v1 + v2)
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          apksigner sign \
            --ks certificado/certificado-keystore.jks \
            --ks-key-alias "cloudfycardapio" \
            --ks-pass pass:"${{ secrets.SENHA_KEYSTORE }}" \
            --key-pass pass:"${{ secrets.SENHA_KEYSTORE }}" \
            --v1-signing-enabled true \
            --v2-signing-enabled true \
            --out app-signed.apk \
            app-aligned.apk

      - name: Renomear arquivos Android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          echo "Renomeando APK"          
          mv app-signed.apk CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
          echo "APK renomeado para CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"

      - name: Criando o release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          files: |
            flutter/speed/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          URLANDROID="https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          echo "$URLANDROID"
          echo "Chamando API de valida√ß√£o..."

          JSON_DATA=$(cat <<EOF
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URLANDROID",
              "NR_ID": ${{ env.UrlId }}
            }
          }
          EOF
          )

          echo $JSON_DATA

          response=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST https://api.cloudfy.net.br/H02SF0107A \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA")

          echo "C√≥digo HTTP: $response"
          cat response.txt

          if [ "$response" != "200" ]; then
            echo "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          fi

      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build ${{env.DeployNameUpperCase}}"
          cwd: ./version-repo
          add: "version${{env.DeployNameUpperCase}}.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
  android-prod:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutter/speed

    steps:
      - name: Gerar Vari√°veis de Ambiente
        working-directory: .
        id: compute
        run: |
          echo 'DeployName=prod' >> $GITHUB_ENV
          echo 'DeployNameUpperCase=Prod' >> $GITHUB_ENV
          echo 'UrlId=5' >> $GITHUB_ENV
          VARIABLE=${{ github.event.inputs.android }}

          # Converte string para 0/1
          if [ "$VARIABLE" = "true" ]; then VARIABLE_BOOL=1; else VARIABLE_BOOL=0; fi          


          # OR l√≥gico
          if [ $((VARIABLE_BOOL)) -eq 1 ]; then
            EXECUTE=true
          else
            EXECUTE=false
          fi

          echo "Valor do execute: $EXECUTE"

          echo "execute=$EXECUTE" >> $GITHUB_OUTPUT
      # Clonar o reposit√≥rio principal do Flutter
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutter

      # Clonar o reposit√≥rio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          path: version-repo

      # Ler e atualizar a vers√£o
      - name: Ler vers√£o atual
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        shell: bash
        run: |
          VERSION_FILE="version${{env.DeployNameUpperCase}}.json"

          # Atualiza o JSON corretamente
          jq '.speedy.build += 1 | .speedy.version += 1 | .speedy.patch = 0' "$VERSION_FILE" > tmp.json

          mv tmp.json "$VERSION_FILE"

          # Pega os valores ap√≥s a atualiza√ß√£o
          BUILD=$(jq -r '.speedy.build' "$VERSION_FILE")
          VERSION=$(jq -r '.speedy.version' "$VERSION_FILE")
          SIMPLE=$(jq -r '.speedy.simple' "$VERSION_FILE")

          echo "Versao Build: $BUILD"
          echo "Versao Version: $VERSION"
          echo "Versao Gerada: $SIMPLE.$VERSION.0"

          echo "VERSAO=$SIMPLE.$VERSION.0" >> $GITHUB_ENV
          echo "VERSAO_BUILD=$BUILD" >> $GITHUB_ENV

          echo "Novo JSON:"
          cat "$VERSION_FILE"

      # Criar o arquivo env/prod.json
      - name: Gerar env/prod.json
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          mkdir -p ./env
          echo '${{ secrets.ENV_PROD }}' > ./env/prod.json
          cat ./env/prod.json

      # Criar arquivo .jks a partir de base64
      - name: Criar arquivo .jks
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          mkdir -p certificado
          echo "${{ secrets.KEYSTORE }}" | base64 -d > certificado/certificado-keystore.jks

      # Setup Shorebird
      - name: üê¶ Setup Shorebird
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # Criar arquivo key.properties
      - name: Criar arquivo key.properties
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          echo "storePassword=${{ secrets.SENHA_KEYSTORE }}" > android/key.properties
          echo "keyPassword=${{ secrets.SENHA_KEYSTORE }}" >> android/key.properties
          echo "keyAlias=cloudfycardapio" >> android/key.properties
          echo "storeFile=../../certificado/certificado-keystore.jks" >> android/key.properties

      # Set Up Java (usando Oracle JDK 17)
      - name: Set Up Java
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: "17"

      # Atualizar vers√£o no arquivo Dart
      - name: Atualiza vers√£o no arquivo Dart e pubspec.yaml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          FILE="lib/Environment/Version.dart"
          NOVA_VERSAO="${{ env.VERSAO }}"
          sed -i "s/const String Version = \".*\"/const String Version = \"$NOVA_VERSAO\"/" $FILE
          cat lib/Environment/Version.dart
          sed -i "s/^version:.*/version: $VERSAO+${{ env.VERSAO_BUILD }}/" pubspec.yaml
          cat pubspec.yaml

      # Executar build do Shorebird
      - name: üöÄ Shorebird Release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        id: shorebird-release
        uses: shorebirdtech/shorebird-release@v1
        with:
          args: --flavor=${{env.DeployName}} --artifact apk -- --dart-define-from-file=env/prod.json --dart-define=FLAVOR=${{env.DeployName}}
          platform: android
          flutter-version: ${{vars.FLUTTER_VERSION_SDK_ANDROID_SMART}}
          working-directory: ./flutter/speed

      - name: Renomear arquivos Android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: .
        run: |
          echo "Renomeando APK"
          if [ -f "flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk" ]; then
            mv flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
            echo "APK renomeado para CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          else
            echo "‚ö†Ô∏è APK n√£o encontrado!"
          fi

          echo "Renomeando AAB"
          if [ -f "flutter/speed/build/app/outputs/bundle/${{env.DeployName}}Release/app-${{env.DeployName}}-release.aab" ]; then
            mv flutter/speed/build/app/outputs/bundle/${{env.DeployName}}Release/app-${{env.DeployName}}-release.aab flutter/speed/build/app/outputs/bundle/${{env.DeployName}}Release/CloudfySpeedyPos${{env.DeployNameUpperCase}}.aab
            echo "AAB renomeado para CloudfySpeedyPos${{env.DeployNameUpperCase}}.aab"
          else
            echo "‚ö†Ô∏è AAB n√£o encontrado!"
          fi

      - name: Criando o release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          files: |
            flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
            flutter/speed/build/app/outputs/bundle/${{env.DeployName}}Release/CloudfySpeedyPos${{env.DeployNameUpperCase}}.aab
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          URLANDROID="https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          echo "$URLANDROID"
          echo "Chamando API de valida√ß√£o..."

          JSON_DATA=$(cat <<EOF
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URLANDROID",
              "NR_ID": ${{ env.UrlId }}
            }
          }
          EOF
          )

          echo $JSON_DATA

          response=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST https://api.cloudfy.net.br/H02SF0107A \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA")

          echo "C√≥digo HTTP: $response"
          cat response.txt

          if [ "$response" != "200" ]; then
            echo "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          fi

      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build ${{env.DeployNameUpperCase}}"
          cwd: ./version-repo
          add: "version${{env.DeployNameUpperCase}}.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
  android-tef:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutter/speed

    steps:
      - name: Gerar Vari√°veis de Ambiente
        working-directory: .
        id: compute
        run: |
          echo 'DeployName=tef' >> $GITHUB_ENV
          echo 'DeployNameUpperCase=Tef' >> $GITHUB_ENV
          echo 'UrlId=11' >> $GITHUB_ENV
          VARIABLE=${{ github.event.inputs.android-tef }}

          # Converte string para 0/1
          if [ "$VARIABLE" = "true" ]; then VARIABLE_BOOL=1; else VARIABLE_BOOL=0; fi          


          # OR l√≥gico
          if [ $((VARIABLE_BOOL)) -eq 1 ]; then
            EXECUTE=true
          else
            EXECUTE=false
          fi

          echo "Valor do execute: $EXECUTE"

          echo "execute=$EXECUTE" >> $GITHUB_OUTPUT
      # Clonar o reposit√≥rio principal do Flutter
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutter

      # Clonar o reposit√≥rio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          path: version-repo

      # Ler e atualizar a vers√£o
      - name: Ler vers√£o atual
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        shell: bash
        run: |
          VERSION_FILE="version${{env.DeployNameUpperCase}}.json"

          # Atualiza o JSON corretamente
          jq '.speedy.build += 1 | .speedy.version += 1 | .speedy.patch = 0' "$VERSION_FILE" > tmp.json

          mv tmp.json "$VERSION_FILE"

          # Pega os valores ap√≥s a atualiza√ß√£o
          BUILD=$(jq -r '.speedy.build' "$VERSION_FILE")
          VERSION=$(jq -r '.speedy.version' "$VERSION_FILE")
          SIMPLE=$(jq -r '.speedy.simple' "$VERSION_FILE")

          echo "Versao Build: $BUILD"
          echo "Versao Version: $VERSION"
          echo "Versao Gerada: $SIMPLE.$VERSION.0"

          echo "VERSAO=$SIMPLE.$VERSION.0" >> $GITHUB_ENV
          echo "VERSAO_BUILD=$BUILD" >> $GITHUB_ENV

          echo "Novo JSON:"
          cat "$VERSION_FILE"

      # Criar o arquivo env/prod.json
      - name: Gerar env/prod.json
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          mkdir -p ./env
          echo '${{ secrets.ENV_PROD }}' > ./env/prod.json
          cat ./env/prod.json

      # Criar arquivo .jks a partir de base64
      - name: Criar arquivo .jks
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          mkdir -p certificado
          echo "${{ secrets.KEYSTORE }}" | base64 -d > certificado/certificado-keystore.jks

      # Setup Shorebird
      - name: üê¶ Setup Shorebird
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # Criar arquivo key.properties
      - name: Criar arquivo key.properties
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          echo "storePassword=${{ secrets.SENHA_KEYSTORE }}" > android/key.properties
          echo "keyPassword=${{ secrets.SENHA_KEYSTORE }}" >> android/key.properties
          echo "keyAlias=cloudfycardapio" >> android/key.properties
          echo "storeFile=../../certificado/certificado-keystore.jks" >> android/key.properties

      # Set Up Java (usando Oracle JDK 17)
      - name: Set Up Java
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: "17"

      # Atualizar vers√£o no arquivo Dart
      - name: Atualiza vers√£o no arquivo Dart e pubspec.yaml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          FILE="lib/Environment/Version.dart"
          NOVA_VERSAO="${{ env.VERSAO }}"
          sed -i "s/const String Version = \".*\"/const String Version = \"$NOVA_VERSAO\"/" $FILE
          cat lib/Environment/Version.dart
          sed -i "s/^version:.*/version: $VERSAO+${{ env.VERSAO_BUILD }}/" pubspec.yaml
          cat pubspec.yaml

      # Executar build do Shorebird
      - name: üöÄ Shorebird Release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        id: shorebird-release
        uses: shorebirdtech/shorebird-release@v1
        with:
          args: --flavor=${{env.DeployName}} --artifact apk -- --dart-define-from-file=env/prod.json --dart-define=FLAVOR=${{env.DeployName}}
          platform: android
          flutter-version: ${{vars.FLUTTER_VERSION_SDK_ANDROID_SMART}}
          working-directory: ./flutter/speed

      - name: Renomear arquivos Android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: .
        run: |
          echo "Renomeando APK"
          if [ -f "flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk" ]; then
            mv flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
            echo "APK renomeado para CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          else
            echo "‚ö†Ô∏è APK n√£o encontrado!"
          fi

      - name: Criando o release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          files: |
            flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          URLANDROID="https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          echo "$URLANDROID"
          echo "Chamando API de valida√ß√£o..."

          JSON_DATA=$(cat <<EOF
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URLANDROID",
              "NR_ID": ${{ env.UrlId }}
            }
          }
          EOF
          )

          echo $JSON_DATA

          response=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST https://api.cloudfy.net.br/H02SF0107A \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA")

          echo "C√≥digo HTTP: $response"
          cat response.txt

          if [ "$response" != "200" ]; then
            echo "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          fi

      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build ${{env.DeployNameUpperCase}}"
          cwd: ./version-repo
          add: "version${{env.DeployNameUpperCase}}.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  android-rede:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutter/speed

    steps:
      - name: Gerar Vari√°veis de Ambiente
        working-directory: .
        id: compute
        run: |
          echo 'DeployName=rede' >> $GITHUB_ENV
          echo 'DeployNameUpperCase=Rede' >> $GITHUB_ENV
          echo 'UrlId=15' >> $GITHUB_ENV
          VARIABLE=${{ github.event.inputs.android-rede }}

          # Converte string para 0/1
          if [ "$VARIABLE" = "true" ]; then VARIABLE_BOOL=1; else VARIABLE_BOOL=0; fi          


          # OR l√≥gico
          if [ $((VARIABLE_BOOL)) -eq 1 ]; then
            EXECUTE=true
          else
            EXECUTE=false
          fi

          echo "Valor do execute: $EXECUTE"

          echo "execute=$EXECUTE" >> $GITHUB_OUTPUT
      # Clonar o reposit√≥rio principal do Flutter
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutter

      # Clonar o reposit√≥rio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          path: version-repo

      # Ler e atualizar a vers√£o
      - name: Ler vers√£o atual
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        shell: bash
        run: |
          VERSION_FILE="version${{env.DeployNameUpperCase}}.json"

          # Atualiza o JSON corretamente
          jq '.speedy.build += 1 | .speedy.version += 1 | .speedy.patch = 0' "$VERSION_FILE" > tmp.json

          mv tmp.json "$VERSION_FILE"

          # Pega os valores ap√≥s a atualiza√ß√£o
          BUILD=$(jq -r '.speedy.build' "$VERSION_FILE")
          VERSION=$(jq -r '.speedy.version' "$VERSION_FILE")
          SIMPLE=$(jq -r '.speedy.simple' "$VERSION_FILE")

          echo "Versao Build: $BUILD"
          echo "Versao Version: $VERSION"
          echo "Versao Gerada: $SIMPLE.$VERSION.0"

          echo "VERSAO=$SIMPLE.$VERSION.0" >> $GITHUB_ENV
          echo "VERSAO_BUILD=$BUILD" >> $GITHUB_ENV

          echo "Novo JSON:"
          cat "$VERSION_FILE"

      # Criar o arquivo env/prod.json
      - name: Gerar env/prod.json
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          mkdir -p ./env
          echo '${{ secrets.ENV_PROD }}' > ./env/prod.json
          cat ./env/prod.json

      # Criar arquivo .jks a partir de base64
      - name: Criar arquivo .jks
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          mkdir -p certificado
          echo "${{ secrets.KEYSTORE }}" | base64 -d > certificado/certificado-keystore.jks

      # Setup Shorebird
      - name: üê¶ Setup Shorebird
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # Criar arquivo key.properties
      - name: Criar arquivo key.properties
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          echo "storePassword=${{ secrets.SENHA_KEYSTORE }}" > android/key.properties
          echo "keyPassword=${{ secrets.SENHA_KEYSTORE }}" >> android/key.properties
          echo "keyAlias=cloudfycardapio" >> android/key.properties
          echo "storeFile=../../certificado/certificado-keystore.jks" >> android/key.properties

      # Set Up Java (usando Oracle JDK 17)
      - name: Set Up Java
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: "17"

      # Atualizar vers√£o no arquivo Dart
      - name: Atualiza vers√£o no arquivo Dart e pubspec.yaml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          FILE="lib/Environment/Version.dart"
          NOVA_VERSAO="${{ env.VERSAO }}"
          sed -i "s/const String Version = \".*\"/const String Version = \"$NOVA_VERSAO\"/" $FILE
          cat lib/Environment/Version.dart
          sed -i "s/^version:.*/version: $VERSAO+${{ env.VERSAO_BUILD }}/" pubspec.yaml
          cat pubspec.yaml

      # Executar build do Shorebird
      - name: üöÄ Shorebird Release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        id: shorebird-release
        uses: shorebirdtech/shorebird-release@v1
        with:
          args: --flavor=${{env.DeployName}} --artifact apk -- --dart-define-from-file=env/prod.json --dart-define=FLAVOR=${{env.DeployName}}
          platform: android
          flutter-version: ${{vars.FLUTTER_VERSION_SDK_ANDROID_SMART}}
          working-directory: ./flutter/speed

      - name: Renomear arquivos Android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: .
        run: |
          echo "Renomeando APK"
          if [ -f "flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk" ]; then
            mv flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
            echo "APK renomeado para CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          else
            echo "‚ö†Ô∏è APK n√£o encontrado!"
          fi

      - name: Criando o release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          files: |
            flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          URLANDROID="https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          echo "$URLANDROID"
          echo "Chamando API de valida√ß√£o..."

          JSON_DATA=$(cat <<EOF
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URLANDROID",
              "NR_ID": ${{ env.UrlId }}
            }
          }
          EOF
          )

          echo $JSON_DATA

          response=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST https://api.cloudfy.net.br/H02SF0107A \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA")

          echo "C√≥digo HTTP: $response"
          cat response.txt

          if [ "$response" != "200" ]; then
            echo "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          fi

      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build ${{env.DeployNameUpperCase}}"
          cwd: ./version-repo
          add: "version${{env.DeployNameUpperCase}}.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
  android-ifood:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutter/speed

    steps:
      - name: Gerar Vari√°veis de Ambiente
        working-directory: .
        id: compute
        run: |
          echo 'DeployName=ifood' >> $GITHUB_ENV
          echo 'DeployNameUpperCase=Ifood' >> $GITHUB_ENV
          echo 'UrlId=20' >> $GITHUB_ENV
          VARIABLE=${{ github.event.inputs.android-ifood }}

          # Converte string para 0/1
          if [ "$VARIABLE" = "true" ]; then VARIABLE_BOOL=1; else VARIABLE_BOOL=0; fi          


          # OR l√≥gico
          if [ $((VARIABLE_BOOL)) -eq 1 ]; then
            EXECUTE=true
          else
            EXECUTE=false
          fi

          echo "Valor do execute: $EXECUTE"

          echo "execute=$EXECUTE" >> $GITHUB_OUTPUT
      # Clonar o reposit√≥rio principal do Flutter
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutter

      # Clonar o reposit√≥rio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          path: version-repo

      # Ler e atualizar a vers√£o
      - name: Ler vers√£o atual
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        shell: bash
        run: |
          VERSION_FILE="version${{env.DeployNameUpperCase}}.json"

          # Atualiza o JSON corretamente
          jq '.speedy.build += 1 | .speedy.version += 1 | .speedy.patch = 0' "$VERSION_FILE" > tmp.json

          mv tmp.json "$VERSION_FILE"

          # Pega os valores ap√≥s a atualiza√ß√£o
          BUILD=$(jq -r '.speedy.build' "$VERSION_FILE")
          VERSION=$(jq -r '.speedy.version' "$VERSION_FILE")
          SIMPLE=$(jq -r '.speedy.simple' "$VERSION_FILE")

          echo "Versao Build: $BUILD"
          echo "Versao Version: $VERSION"
          echo "Versao Gerada: $SIMPLE.$VERSION.0"

          echo "VERSAO=$SIMPLE.$VERSION.0" >> $GITHUB_ENV
          echo "VERSAO_BUILD=$BUILD" >> $GITHUB_ENV

          echo "Novo JSON:"
          cat "$VERSION_FILE"

      # Criar o arquivo env/prod.json
      - name: Gerar env/prod.json
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          mkdir -p ./env
          echo '${{ secrets.ENV_PROD }}' > ./env/prod.json
          cat ./env/prod.json

      # Criar arquivo .jks a partir de base64
      - name: Criar arquivo .jks
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          mkdir -p certificado
          echo "${{ secrets.KEYSTORE }}" | base64 -d > certificado/certificado-keystore.jks

      # Setup Shorebird
      - name: üê¶ Setup Shorebird
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # Criar arquivo key.properties
      - name: Criar arquivo key.properties
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          echo "storePassword=${{ secrets.SENHA_KEYSTORE }}" > android/key.properties
          echo "keyPassword=${{ secrets.SENHA_KEYSTORE }}" >> android/key.properties
          echo "keyAlias=cloudfycardapio" >> android/key.properties
          echo "storeFile=../../certificado/certificado-keystore.jks" >> android/key.properties

      # Set Up Java (usando Oracle JDK 17)
      - name: Set Up Java
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: "17"

      # Atualizar vers√£o no arquivo Dart
      - name: Atualiza vers√£o no arquivo Dart e pubspec.yaml
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        shell: bash
        run: |
          FILE="lib/Environment/Version.dart"
          NOVA_VERSAO="${{ env.VERSAO }}"
          sed -i "s/const String Version = \".*\"/const String Version = \"$NOVA_VERSAO\"/" $FILE
          cat lib/Environment/Version.dart
          sed -i "s/^version:.*/version: $VERSAO+${{ env.VERSAO_BUILD }}/" pubspec.yaml
          cat pubspec.yaml

      # Executar build do Shorebird
      - name: üöÄ Shorebird Release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        id: shorebird-release
        uses: shorebirdtech/shorebird-release@v1
        with:
          args: --flavor=${{env.DeployName}} --artifact apk -- --dart-define-from-file=env/prod.json --dart-define=FLAVOR=${{env.DeployName}}
          platform: android
          flutter-version: ${{vars.FLUTTER_VERSION_SDK_ANDROID_SMART}}
          working-directory: ./flutter/speed

      - name: Renomear arquivos Android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: .
        run: |
          echo "Renomeando APK"
          if [ -f "flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk" ]; then
            mv flutter/speed/build/app/outputs/flutter-apk/app-${{env.DeployName}}-release.apk flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
            echo "APK renomeado para CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          else
            echo "‚ö†Ô∏è APK n√£o encontrado!"
          fi

      - name: Criando o release
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          name: v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}
          files: |
            flutter/speed/build/app/outputs/flutter-apk/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados android
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        run: |
          URLANDROID="https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_Speedy${{env.DeployNameUpperCase}}/CloudfySpeedyPos${{env.DeployNameUpperCase}}.apk"
          echo "$URLANDROID"
          echo "Chamando API de valida√ß√£o..."

          JSON_DATA=$(cat <<EOF
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URLANDROID",
              "NR_ID": ${{ env.UrlId }}
            }
          }
          EOF
          )

          echo $JSON_DATA

          response=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST https://api.cloudfy.net.br/H02SF0107A \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA")

          echo "C√≥digo HTTP: $response"
          cat response.txt

          if [ "$response" != "200" ]; then
            echo "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          fi

      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ (steps.compute.outputs.execute == 'true') }}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build ${{env.DeployNameUpperCase}}"
          cwd: ./version-repo
          add: "version${{env.DeployNameUpperCase}}.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
  ios:
    runs-on: macos-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutter/speed

    steps:
      # Clonar o reposit√≥rio principal do Flutter
      - uses: actions/checkout@v4
        if: ${{ inputs.ios}}
        with:
          repository: cloudfysystems/FLUTTER
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutter

      # Clonar o reposit√≥rio de vers√£o
      - uses: actions/checkout@v4
        if: ${{ inputs.ios}}
        with:
          path: version-repo

      # Ler e atualizar a vers√£o
      - name: Ler vers√£o atual
        if: ${{ inputs.ios}}
        working-directory: version-repo
        shell: bash
        run: |
          VERSION_FILE="versionIOS.json"

          # Atualiza o JSON corretamente
          jq '.speedy.build += 1 | .speedy.version += 1 | .speedy.patch = 0' "$VERSION_FILE" > tmp.json

          mv tmp.json "$VERSION_FILE"

          # Pega os valores ap√≥s a atualiza√ß√£o
          BUILD=$(jq -r '.speedy.build' "$VERSION_FILE")
          VERSION=$(jq -r '.speedy.version' "$VERSION_FILE")
          SIMPLE=$(jq -r '.speedy.simple' "$VERSION_FILE")

          echo "Versao Build: $BUILD"
          echo "Versao Version: $VERSION"
          echo "Versao Gerada: $SIMPLE.$VERSION.0"

          echo "VERSAO=$SIMPLE.$VERSION.0" >> $GITHUB_ENV
          echo "VERSAO_BUILD=$BUILD" >> $GITHUB_ENV

          echo "Novo JSON:"
          cat "$VERSION_FILE"

      # Criar o arquivo env/prod.json
      - name: Gerar env/prod.json
        if: ${{ inputs.ios}}
        run: |
          mkdir -p ./env
          echo '${{ secrets.ENV_PROD }}' > ./env/prod.json
          cat ./env/prod.json

      - name: Import code sign
        if: ${{ inputs.ios}}
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.APPLE_CERT_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERT_PSW }}

      - name: Download provisioning
        if: ${{ inputs.ios}}
        uses: Apple-Actions/download-provisioning-profiles@v1
        with:
          bundle-id: com.cloudfy.speed
          issuer-id: ${{ secrets.APPLE_API_ISSUER_ID }}
          api-key-id: ${{ secrets.APPLE_API_KEY }}
          api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
      - name: Configure Auth Key
        if: ${{ inputs.ios}}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APPLE_API_PRIVATE_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APPLE_API_KEY }}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APPLE_API_KEY }}.p8

      # Atualizar vers√£o no arquivo Dart
      - name: Atualiza vers√£o no arquivo Dart e pubspec.yaml
        if: ${{ inputs.ios }}
        shell: bash
        run: |
          FILE="lib/Environment/Version.dart"
          NOVA_VERSAO="${{ env.VERSAO }}"
              
          # Atualiza Version.dart
          sed -i '' "s/const String Version = \".*\"/const String Version = \"$NOVA_VERSAO\"/" "$FILE"
          cat "$FILE"
              
          # Atualiza pubspec.yaml
          sed -i '' "s/^version:.*/version: $VERSAO+${{ env.VERSAO_BUILD }}/" pubspec.yaml
          cat pubspec.yaml
      # Setup Shorebird
      - name: üê¶ Setup Shorebird
        if: ${{ inputs.ios}}
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # Executar build do Shorebird
      - name: üöÄ Shorebird Release
        if: ${{ inputs.ios}}
        id: shorebird-release
        uses: shorebirdtech/shorebird-release@v1
        with:
          args: --export-options-plist ios/GHAExportOptions.plist -- --dart-define-from-file=env/prod.json
          platform: ios
          flutter-version: ${{vars.FLUTTER_VERSION_SDK_ANDROID_SMART}}
          working-directory: ./flutter/speed

      - name: Renomear arquivos iOS
        if: ${{ inputs.ios}}
        working-directory: .
        run: |
          echo "Renomeando IPA"
          if [ -f "flutter/speed/build/ios/ipa/speed.ipa" ]; then
            mv flutter/speed/build/ios/ipa/speed.ipa flutter/speed/build/ios/ipa/CloudfySpeedyPos.ipa
            echo "IPA renomeado para CloudfySpeedyPos.ipa"
          else
            echo "‚ö†Ô∏è IPA n√£o encontrado!"
          fi

      - name: Criando o release
        if: ${{ inputs.ios}}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSAO }}_SpeedyIOS
          name: v${{ env.VERSAO }}_SpeedyIOS
          files: |
            flutter/speed/build/ios/ipa/CloudfySpeedyPos.ipa
          body: Release gerado automaticamente.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Chamar API de altera√ß√£o de dados android
        if: ${{ inputs.ios}}
        run: |
          URLIOS="https://github.com/cloudfysystems/Version/releases/download/v${{ env.VERSAO }}_SpeedyIOS/CloudfySpeedyPos.ipa"
          echo "$URLIOS"
          echo "Chamando API de valida√ß√£o..."

          JSON_DATA=$(cat <<EOF
          {
            "JSON": true,
            "Parameters": {
              "Versao": "${{ env.VERSAO }}",
              "PSW": "${{ secrets.SENHA_API_ALTERAR_URL }}",
              "URL": "$URLIOS",
              "NR_ID": 16
            }
          }
          EOF
          )

          echo $JSON_DATA

          response=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST https://api.cloudfy.net.br/H02SF0107A \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA")

          echo "C√≥digo HTTP: $response"
          cat response.txt

          if [ "$response" != "200" ]; then
            echo "‚ùå Falha na chamada da API. Abortando workflow."
            exit 1
          fi

      - name: Atualizar branch com merge (se necess√°rio)
        if: ${{ inputs.ios}}
        working-directory: version-repo
        run: |
          git config user.name "cloudfysystems"
          git config user.email "cloudfysystems@gmail.com"

          # Garante que estamos na branch correta
          git branch --show-current

          # Tenta fazer pull e merge autom√°tico
          git pull origin HEAD --no-rebase || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit das altera√ß√µes
        uses: EndBug/add-and-commit@v9
        if: ${{ inputs.ios}}
        with:
          author_name: cloudfysystems
          author_email: cloudfysystems@gmail.com
          message: "alterada vers√£o do build IOS"
          cwd: ./version-repo
          add: "versionIOS.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Upload IPA to App Store Connect
        if: ${{ inputs.ios}}
        run: xcrun altool --upload-app --type ios -f ./build/ios/ipa/CloudfySpeedyPos.ipa --apiKey ${{ secrets.APPLE_API_KEY }} --apiIssuer ${{ secrets.APPLE_API_ISSUER_ID }}
  #Job que vai atualizar o git, sincronizar os fontes
  FinishJob:
    needs:
      [
        Windows,
        android-rede,
        android-cielo,
        android-pagseguro,
        android-getnet,
        android-tef,
        android-prod,
        android-stone,
        android-ifood,
        ios,
      ]
    runs-on: ubuntu-latest
    if: ${{ inputs.email}}
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./flutterrepo

    steps:
      - name: Calculando a combina√ß√£o dos booleans Android
        id: compute
        working-directory: .
        run: |
          WINDOWS=${{ github.event.inputs.windows }}
          ANDROID=${{ github.event.inputs.android }}
          TEF=${{ github.event.inputs.android-tef }}
          PAGSEGURO=${{ github.event.inputs.android-pagseguro }}
          GETNET=${{ github.event.inputs.android-getnet }}
          CIELO=${{ github.event.inputs.android-cielo }}
          REDE=${{ github.event.inputs.android-rede }}
          STONE=${{ github.event.inputs.android-stone }}
          IOS=${{ github.event.inputs.ios }}          



          # Converte string para 0/1
          if [ "$ANDROID" = "true" ]; then ANDROID_BOOL=1; else ANDROID_BOOL=0; fi
          if [ "$TEF" = "true" ]; then TEF_BOOL=1; else TEF_BOOL=0; fi
          if [ "$PAGSEGURO" = "true" ]; then PAGSEGURO_BOOL=1; else PAGSEGURO_BOOL=0; fi
          if [ "$GETNET" = "true" ]; then GETNET_BOOL=1; else GETNET_BOOL=0; fi
          if [ "$CIELO" = "true" ]; then CIELO_BOOL=1; else CIELO_BOOL=0; fi
          if [ "$REDE" = "true" ]; then REDE_BOOL=1; else REDE_BOOL=0; fi
          if [ "$WINDOWS" = "true" ]; then WINDOWS_BOOL=1; else WINDOWS_BOOL=0; fi
          if [ "$IOS" = "true" ]; then IOS_BOOL=1; else IOS_BOOL=0; fi
          if [ "$STONE" = "true" ]; then STONE_BOOL=1; else STONE_BOOL=0; fi          




          # OR l√≥gico
          if [ $((ANDROID_BOOL | TEF_BOOL | PAGSEGURO_BOOL | GETNET_BOOL | CIELO_BOOL | REDE_BOOL | WINDOWS_BOOL | IOS_BOOL | STONE_BOOL)) -eq 1 ]; then
            COMBINED=true
          else
            COMBINED=false
          fi


          echo "combined=$COMBINED" >> $GITHUB_OUTPUT
      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.combined == 'true') }}
        with:
          repository: cloudfysystems/FLUTTER
          fetch-depth: 0
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: flutterrepo

      - uses: actions/checkout@v4
        if: ${{ (steps.compute.outputs.combined == 'true') }}
        with:
          path: version-repo

      - name: Recuperando os commits entre produ√ß√£o e main
        id: log
        if: ${{ (steps.compute.outputs.combined == 'true') }}
        continue-on-error: true
        run: |
          git config --global user.name "cloudfysystems"
          git config --global user.email "cloudfysystem@gmail.com"
          git config --global pull.rebase false
          git pull origin production
          commits=$(git log origin/production..origin/main --pretty=format:"- %s (%an)<br>" --no-merges)
          {
            echo "commit_messages<<EOF"
            echo "$commits"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          git checkout production
          git merge origin/main --no-ff -m "gerando versao na falcatrua" --allow-unrelated-histories
          git push origin production

      - name: Envia e-mail com resumo
        uses: dawidd6/action-send-mail@v3
        if: ${{ (steps.compute.outputs.combined == 'true') }}
        with:
          server_address: mail.cloudfy.net.br
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "Speedy POS - Gerado vers√£o em produ√ß√£o"
          html_body: |
            <p><b>Ol√° time!</b></p>


            Foi gerada uma nova vers√£o em produ√ß√£o do SpeedyPOS!<br><br>
              
            Commits inclu√≠dos:<br><br>
              
            <b>${{ steps.log.outputs.commit_messages }}</b><br><br>
              
            <p>Os novos arquivos est√£o disponiveis na area de download</p>
              
            <p><b>Menos foco, mais ansiedade!</b></p>
          to: ${{ vars.EMAIL }}
          from: Cloudfy Vers√£o <noreply@cloudfy.net.br>
          secure: true
